(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();const T="/api";async function k(e){const t=await fetch(`${T}${e}`);if(!t.ok)throw new Error(`API error: ${t.status} ${t.statusText}`);return t.json()}async function W(){return(await k("/graph")).data}async function A(){return(await k("/git/changes")).data}function O(e,t){const{onOpen:n,onClose:o,onError:a,reconnect:s=!0,reconnectDelay:l=3e3}=t??{};let i=null,$=null,S=!1;function N(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/api/ws`}function C(){S||(i=new WebSocket(N()),i.onopen=()=>{console.log("[WS] Connected"),n==null||n(),P()},i.onmessage=p=>{try{const v=JSON.parse(p.data);e(v)}catch(v){console.error("[WS] Failed to parse message:",v)}},i.onclose=()=>{console.log("[WS] Disconnected"),b(),o==null||o(),s&&!S&&(console.log(`[WS] Reconnecting in ${l}ms...`),$=window.setTimeout(C,l))},i.onerror=p=>{console.error("[WS] Error:",p),a==null||a(p)})}let m=null;function P(){b(),m=window.setInterval(()=>{(i==null?void 0:i.readyState)===WebSocket.OPEN&&i.send(JSON.stringify({type:"ping"}))},3e4)}function b(){m!==null&&(clearInterval(m),m=null)}return C(),{send:p=>{(i==null?void 0:i.readyState)===WebSocket.OPEN?i.send(JSON.stringify(p)):console.warn("[WS] Cannot send, not connected")},close:()=>{S=!0,b(),$!==null&&clearTimeout($),i==null||i.close()}}}const G="/api/ops";async function h(e){const t=await fetch(`${G}${e}`),n=await t.json();if(!t.ok){const o=n.data;throw new Error(o.message||`API error: ${t.status}`)}return n.data}async function R(e){const t=await fetch(`${G}${e}`,{method:"DELETE"}),n=await t.json();if(!t.ok){const o=n.data;throw new Error(o.message||`API error: ${t.status}`)}return n.data}async function M(e,t={}){const n=new URLSearchParams({source:e});return t.ignore&&n.set("ignore",t.ignore),t.noSave&&n.set("no_save","true"),t.useCache&&n.set("use_cache","true"),t.force&&n.set("force","true"),h(`/sync?${n}`)}async function B(e,t={}){const n=new URLSearchParams({path:e});return t.force&&n.set("force","true"),h(`/graph?${n}`)}async function j(e,t={}){const n=new URLSearchParams({path:e});return t.detailed&&n.set("detailed","true"),h(`/status?${n}`)}async function U(e){return h(`/load?path=${encodeURIComponent(e)}`)}async function x(e){return R(`/clean?path=${encodeURIComponent(e)}`)}async function D(e){return h(`/git-changes?path=${encodeURIComponent(e)}`)}let u=null,r=null,y=null,f=null;function c(e,t=!1){f&&(f.textContent=e,f.className=`topbar-message ${t?"error":"success"}`,setTimeout(()=>{f&&f.textContent===e&&(f.textContent="",f.className="topbar-message")},5e3))}function d(e){document.querySelectorAll(".topbar-btn").forEach(t=>{t.disabled=e}),u&&u.classList.toggle("loading",e)}function E(e){var o,a;if(!y)return;if(!e){y.innerHTML='<span class="status-placeholder">No status</span>';return}const t=e.workspace.kind.type==="single_repo"?"ğŸ“ Single Repo":e.workspace.kind.type==="multi_repo"?`ğŸ“¦ ${e.workspace.kind.repo_count} Repos`:"ğŸ“‚ Directory",n=e.store_exists?`âœ… .self (${((o=e.manifest)==null?void 0:o.source_count)||0} files)`:"âŒ Not synced";y.innerHTML=`
    <span class="status-item" title="${e.workspace.root}">${t} <strong>${e.workspace.name}</strong></span>
    <span class="status-divider">|</span>
    <span class="status-item">${n}</span>
    ${(a=e.manifest)!=null&&a.remote?`<span class="status-divider">|</span><span class="status-item">ğŸ”— ${e.manifest.remote.split("/").slice(-2).join("/")}</span>`:""}
  `}async function H(e=!1){const t=(r==null?void 0:r.value)||".";d(!0),c("Syncing...");try{const n=await M(t,{force:e}),o=n.project.repositories.reduce((a,s)=>a+s.sources.length,0);c(`âœ… Synced: ${n.project.repositories.length} repos, ${o} files`),await w(!0),window.dispatchEvent(new CustomEvent("vibe-graph-synced"))}catch(n){c(`âŒ Sync failed: ${n.message}`,!0)}finally{d(!1)}}async function I(e=!1){const t=(r==null?void 0:r.value)||".";d(!0),c("Building graph...");try{const n=await B(t,{force:e});c(`âœ… Graph: ${n.graph.nodes.length} nodes, ${n.graph.edges.length} edges${n.from_cache?" (cached)":""}`),window.dispatchEvent(new CustomEvent("vibe-graph-updated"))}catch(n){c(`âŒ Graph failed: ${n.message}`,!0)}finally{d(!1)}}async function w(e=!1){const t=(r==null?void 0:r.value)||".";e||(d(!0),c("Getting status..."));try{const n=await j(t,{detailed:!0});E(n),e||c(`âœ… ${n.workspace.name}: ${n.store_exists?"synced":"not synced"}`)}catch(n){e||c(`âŒ Status failed: ${n.message}`,!0),E(null)}finally{e||d(!1)}}async function q(){const e=(r==null?void 0:r.value)||".";d(!0),c("Loading project...");try{const t=await U(e),n=t.project.repositories.reduce((o,a)=>o+a.sources.length,0);c(`âœ… Loaded: ${t.manifest.name} (${t.manifest.repo_count} repos, ${n} files)`)}catch(t){c(`âŒ Load failed: ${t.message}`,!0)}finally{d(!1)}}async function J(){const e=(r==null?void 0:r.value)||".";if(confirm("Remove .self folder? This will delete all cached data.")){d(!0),c("Cleaning...");try{const t=await x(e);c(t.cleaned?"âœ… Cleaned .self folder":"â„¹ï¸ No .self folder to clean"),await w(!0)}catch(t){c(`âŒ Clean failed: ${t.message}`,!0)}finally{d(!1)}}}async function F(){const e=(r==null?void 0:r.value)||".";d(!0),c("Getting git changes...");try{const t=await D(e),n=t.changes.filter(l=>l.kind==="Modified").length,o=t.changes.filter(l=>l.kind==="Added"||l.kind==="Untracked").length,a=t.changes.filter(l=>l.kind==="Deleted").length;let s=`ğŸ“ Git: ${t.changes.length} changes`;n&&(s+=` (${n} modified)`),o&&(s+=` (${o} added)`),a&&(s+=` (${a} deleted)`),c(s)}catch(t){c(`âŒ Git changes failed: ${t.message}`,!0)}finally{d(!1)}}function g(e,t,n,o){const a=document.createElement("button");return a.className="topbar-btn",a.innerHTML=`<span class="btn-icon">${t}</span><span class="btn-label">${e}</span>`,a.title=o,a.onclick=n,a}function V(e){const t=document.getElementById(e);if(!t){console.error(`[TopBar] Target element #${e} not found`);return}u=document.createElement("div"),u.className="topbar",u.innerHTML=`
    <div class="topbar-left">
      <div class="topbar-brand">
        <span class="brand-icon">â—ˆ</span>
        <span class="brand-name">Vibe Graph</span>
      </div>
    </div>
    <div class="topbar-center">
      <div class="topbar-path">
        <label for="path-input">Path:</label>
        <input type="text" id="path-input" value="." placeholder="." />
      </div>
      <div class="topbar-actions"></div>
    </div>
    <div class="topbar-right">
      <div class="topbar-status" id="topbar-status"></div>
      <div class="topbar-message" id="topbar-message"></div>
    </div>
  `,t.appendChild(u),r=u.querySelector("#path-input"),y=u.querySelector("#topbar-status"),f=u.querySelector("#topbar-message");const n=u.querySelector(".topbar-actions");n&&(n.appendChild(g("Sync","ğŸ”„",()=>H(),"Scan and index codebase")),n.appendChild(g("Graph","ğŸ“Š",()=>I(),"Build source code graph")),n.appendChild(g("Status","â„¹ï¸",()=>w(),"Show workspace status")),n.appendChild(g("Load","ğŸ“‚",()=>q(),"Load from .self store")),n.appendChild(g("Git","ğŸ“",()=>F(),"Show git changes")),n.appendChild(g("Clean","ğŸ—‘ï¸",()=>J(),"Remove .self folder"))),w(!0)}function _(){return document.getElementById("loading")}function z(e){const t=_();t&&(t.classList.add("error"),t.innerHTML=`<span>Error: ${e}</span>`)}function L(e){const t=_();if(t){const n=t.querySelector("span");n&&(n.textContent=e)}}function Q(e){switch(e.type){case"git_changes":window.VIBE_GIT_CHANGES=JSON.stringify(e.data),console.log(`[WS] Git changes updated: ${e.data.changes.length} changes`);break;case"graph_updated":console.log(`[WS] Graph updated: ${e.node_count} nodes, ${e.edge_count} edges`),window.dispatchEvent(new CustomEvent("vibe-graph-updated"));break;case"error":console.error(`[WS] Server error: ${e.code} - ${e.message}`);break}}async function K(){try{V("topbar-container"),console.log("[Main] TopBar rendered"),L("Fetching graph data...");const e=await W();console.log(`[API] Loaded graph: ${e.nodes.length} nodes, ${e.edges.length} edges`);const t=await A();console.log(`[API] Loaded git changes: ${t.changes.length} files`),window.VIBE_GRAPH_DATA=JSON.stringify(e),window.VIBE_GIT_CHANGES=JSON.stringify(t),L("Loading visualization..."),window.dispatchEvent(new CustomEvent("vibe-graph-ready")),O(Q,{onOpen:()=>console.log("[Main] WebSocket connected"),onClose:()=>console.log("[Main] WebSocket disconnected")})}catch(e){console.error("[Main] Initialization failed:",e),z(e instanceof Error?e.message:"Unknown error")}}K();
